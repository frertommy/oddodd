<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Detail - OddOdd</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="chart-utils.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #e2e8f0;
            line-height: 1.6;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* View Toggle */
        .view-toggle {
            display: flex;
            justify-content: center;
            gap: 0;
            margin-bottom: 20px;
        }
        
        .view-toggle-btn {
            background: rgba(15, 23, 42, 0.5);
            border: 1px solid rgba(255,255,255,0.1);
            color: #94a3b8;
            padding: 10px 24px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .view-toggle-btn:first-child {
            border-radius: 8px 0 0 8px;
            border-right: none;
        }
        
        .view-toggle-btn:last-child {
            border-radius: 0 8px 8px 0;
            border-left: none;
        }
        
        .view-toggle-btn:hover {
            color: #e2e8f0;
            background: rgba(30, 41, 59, 0.8);
        }
        
        .view-toggle-btn.active {
            background: rgba(96, 165, 250, 0.2);
            color: #60a5fa;
            border-color: rgba(96, 165, 250, 0.3);
        }
        
        header {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 20px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 30px;
        }
        
        .back-btn {
            background: rgba(96, 165, 250, 0.2);
            border: 1px solid rgba(96, 165, 250, 0.3);
            color: #60a5fa;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .back-btn:hover {
            background: rgba(96, 165, 250, 0.3);
        }
        
        .market-header {
            flex: 1;
        }
        
        h1 {
            font-size: 1.8rem;
            background: linear-gradient(135deg, #60a5fa, #a78bfa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .market-meta {
            color: #64748b;
            font-size: 0.9rem;
            margin-top: 5px;
        }
        
        .current-value {
            text-align: right;
        }
        
        .value-display {
            font-size: 2.5rem;
            font-weight: 700;
            color: #f8fafc;
            font-family: 'SF Mono', Monaco, monospace;
        }
        
        .change-display {
            font-size: 1.1rem;
            font-weight: 600;
            margin-top: 5px;
        }
        
        .change-display.positive { color: #4ade80; }
        .change-display.negative { color: #f87171; }
        .change-display.neutral { color: #94a3b8; }
        
        /* Main Layout for Market View */
        .market-view-layout {
            display: grid;
            grid-template-columns: 1fr 360px;
            gap: 24px;
        }
        
        @media (max-width: 1024px) {
            .market-view-layout {
                grid-template-columns: 1fr;
            }
        }
        
        /* Chart Controls */
        .chart-controls {
            background: rgba(30, 41, 59, 0.8);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            align-items: center;
        }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .control-label {
            font-size: 0.85rem;
            color: #94a3b8;
            font-weight: 500;
        }
        
        .timeframe-toggle {
            display: flex;
            gap: 4px;
            background: rgba(15, 23, 42, 0.5);
            padding: 4px;
            border-radius: 8px;
        }
        
        .timeframe-btn {
            background: transparent;
            border: none;
            color: #94a3b8;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }
        
        .timeframe-btn:hover { color: #e2e8f0; }
        .timeframe-btn.active {
            background: rgba(96, 165, 250, 0.2);
            color: #60a5fa;
        }
        
        .range-presets {
            display: flex;
            gap: 4px;
        }
        
        .range-btn {
            background: rgba(15, 23, 42, 0.5);
            border: 1px solid rgba(255,255,255,0.1);
            color: #94a3b8;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s;
        }
        
        .range-btn:hover { color: #e2e8f0; border-color: rgba(255,255,255,0.2); }
        .range-btn.active {
            background: rgba(96, 165, 250, 0.2);
            color: #60a5fa;
            border-color: rgba(96, 165, 250, 0.3);
        }
        
        .date-inputs {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .date-input {
            background: rgba(15, 23, 42, 0.5);
            border: 1px solid rgba(255,255,255,0.1);
            color: #e2e8f0;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-family: inherit;
        }
        
        .date-input:focus {
            outline: none;
            border-color: rgba(96, 165, 250, 0.5);
        }
        
        select {
            background: rgba(15, 23, 42, 0.5);
            border: 1px solid rgba(255,255,255,0.1);
            color: #e2e8f0;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-family: inherit;
            cursor: pointer;
        }
        
        select:focus {
            outline: none;
            border-color: rgba(96, 165, 250, 0.5);
        }
        
        .chart-legend {
            font-size: 0.85rem;
            color: #94a3b8;
            margin-left: auto;
        }
        
        .band-info {
            font-size: 0.8rem;
            color: #64748b;
            background: rgba(15, 23, 42, 0.5);
            padding: 6px 12px;
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.05);
            font-family: 'SF Mono', Monaco, monospace;
        }
        
        .band-info:empty { display: none; }
        
        /* Chart Section */
        .chart-section {
            background: rgba(30, 41, 59, 0.8);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 30px;
        }
        
        .chart-container {
            position: relative;
            height: 400px;
        }
        
        .fallback-notice {
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid rgba(251, 191, 36, 0.3);
            color: #fbbf24;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 0.85rem;
            margin-bottom: 16px;
            display: none;
        }
        
        .fallback-notice.visible { display: block; }
        
        /* YES% Chart Section - Data View */
        .yes-section {
            margin-top: 20px;
        }
        
        .yes-controls {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px 16px;
            background: rgba(15, 23, 42, 0.5);
            border-radius: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        
        .yes-band-toggle {
            display: flex;
            gap: 4px;
            background: rgba(30, 41, 59, 0.8);
            padding: 4px;
            border-radius: 8px;
        }
        
        .yes-band-btn {
            background: transparent;
            border: none;
            color: #94a3b8;
            padding: 6px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .yes-band-btn:hover { color: #e2e8f0; }
        .yes-band-btn.active {
            background: rgba(96, 165, 250, 0.2);
            color: #60a5fa;
        }
        
        .yes-band-info {
            font-size: 0.8rem;
            color: #64748b;
            font-family: 'SF Mono', Monaco, monospace;
            margin-left: auto;
        }
        
        .yes-range-toggle {
            display: flex;
            gap: 4px;
            background: rgba(30, 41, 59, 0.8);
            padding: 4px;
            border-radius: 8px;
        }
        
        .yes-range-btn {
            background: transparent;
            border: none;
            color: #94a3b8;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .yes-range-btn:hover { color: #e2e8f0; }
        .yes-range-btn.active {
            background: rgba(167, 139, 250, 0.2);
            color: #a78bfa;
        }
        
        /* Data Table */
        .data-table-section {
            background: rgba(30, 41, 59, 0.8);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .section-title {
            font-size: 1.2rem;
            color: #e2e8f0;
        }
        
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        
        th {
            color: #94a3b8;
            font-weight: 500;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        td { color: #e2e8f0; }
        tr:hover { background: rgba(96, 165, 250, 0.05); }
        
        .cell-value {
            font-family: 'SF Mono', Monaco, monospace;
            font-weight: 600;
        }
        
        .cell-change { text-align: right; }
        .cell-change.positive { color: #4ade80; }
        .cell-change.negative { color: #f87171; }
        
        /* Prediction Markets */
        .prediction-markets {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .pm-button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            border-radius: 8px;
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .pm-button:hover { transform: translateY(-2px); }
        
        .pm-kalshi {
            background: rgba(74, 222, 128, 0.15);
            color: #4ade80;
            border: 1px solid rgba(74, 222, 128, 0.3);
        }
        .pm-kalshi:hover { background: rgba(74, 222, 128, 0.25); }
        
        .pm-polymarket {
            background: rgba(96, 165, 250, 0.15);
            color: #60a5fa;
            border: 1px solid rgba(96, 165, 250, 0.3);
        }
        .pm-polymarket:hover { background: rgba(96, 165, 250, 0.25); }
        
        /* Fake Polymarket Trade Panel */
        .trade-panel {
            background: rgba(30, 41, 59, 0.9);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid rgba(255,255,255,0.1);
            height: fit-content;
            position: sticky;
            top: 20px;
        }
        
        .trade-panel-header {
            display: flex;
            gap: 4px;
            margin-bottom: 20px;
            background: rgba(15, 23, 42, 0.5);
            padding: 4px;
            border-radius: 8px;
        }
        
        .trade-panel-tab {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.2s;
            background: transparent;
            color: #94a3b8;
        }
        
        .trade-panel-tab.active {
            background: rgba(96, 165, 250, 0.2);
            color: #60a5fa;
        }
        
        .trade-panel-tab.buy.active {
            background: rgba(74, 222, 128, 0.2);
            color: #4ade80;
        }
        
        .trade-panel-tab.sell.active {
            background: rgba(248, 113, 113, 0.2);
            color: #f87171;
        }
        
        .outcome-tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 20px;
        }
        
        .outcome-tab {
            flex: 1;
            padding: 12px;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.2s;
            background: rgba(15, 23, 42, 0.5);
            color: #94a3b8;
        }
        
        .outcome-tab:hover {
            border-color: rgba(255,255,255,0.2);
        }
        
        .outcome-tab.active.yes {
            background: rgba(74, 222, 128, 0.2);
            border-color: rgba(74, 222, 128, 0.5);
            color: #4ade80;
        }
        
        .outcome-tab.active.no {
            background: rgba(248, 113, 113, 0.2);
            border-color: rgba(248, 113, 113, 0.5);
            color: #f87171;
        }
        
        .price-display {
            text-align: center;
            margin-bottom: 24px;
            padding: 16px;
            background: rgba(15, 23, 42, 0.5);
            border-radius: 12px;
        }
        
        .price-label {
            font-size: 0.8rem;
            color: #64748b;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .price-value {
            font-size: 2.5rem;
            font-weight: 700;
            font-family: 'SF Mono', Monaco, monospace;
        }
        
        .price-value.yes { color: #4ade80; }
        .price-value.no { color: #f87171; }
        
        .input-group {
            margin-bottom: 16px;
        }
        
        .input-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: #94a3b8;
            margin-bottom: 8px;
        }
        
        .input-field {
            width: 100%;
            padding: 12px 16px;
            background: rgba(15, 23, 42, 0.5);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            color: #e2e8f0;
            font-size: 1rem;
            font-family: 'SF Mono', Monaco, monospace;
            transition: all 0.2s;
        }
        
        .input-field:focus {
            outline: none;
            border-color: rgba(96, 165, 250, 0.5);
        }
        
        .input-field:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .trade-cta {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 700;
            cursor: not-allowed;
            transition: all 0.2s;
            margin-top: 8px;
        }
        
        .trade-cta.buy-yes {
            background: rgba(74, 222, 128, 0.3);
            color: #4ade80;
        }
        
        .trade-cta.buy-no {
            background: rgba(248, 113, 113, 0.3);
            color: #f87171;
        }
        
        .trade-cta:disabled {
            opacity: 0.5;
        }
        
        .demo-notice {
            text-align: center;
            padding: 12px;
            margin-top: 16px;
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid rgba(251, 191, 36, 0.3);
            border-radius: 8px;
            color: #fbbf24;
            font-size: 0.85rem;
        }
        
        .trade-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.05);
        }
        
        .trade-stat {
            text-align: center;
        }
        
        .trade-stat-label {
            font-size: 0.75rem;
            color: #64748b;
            margin-bottom: 4px;
        }
        
        .trade-stat-value {
            font-size: 1rem;
            font-weight: 600;
            color: #e2e8f0;
            font-family: 'SF Mono', Monaco, monospace;
        }
        
        /* Market View Chart Section */
        .market-view-chart-section {
            background: rgba(30, 41, 59, 0.8);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .market-view-chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            flex-wrap: wrap;
            gap: 12px;
        }
        
        .market-view-chart-title {
            font-size: 1.1rem;
            color: #e2e8f0;
        }
        
        .yes-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: rgba(74, 222, 128, 0.15);
            border: 1px solid rgba(74, 222, 128, 0.3);
            border-radius: 20px;
            color: #4ade80;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        @media (max-width: 768px) {
            .value-display { font-size: 1.8rem; }
            .chart-container { height: 300px; }
            .chart-controls { flex-direction: column; align-items: stretch; }
            .control-group { justify-content: space-between; }
            .chart-legend { margin-left: 0; text-align: center; }
            .trade-panel { position: static; }
            .price-value { font-size: 2rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- View Toggle -->
        <div class="view-toggle">
            <button class="view-toggle-btn" data-view="data" onclick="setView('data')">üìà Data View</button>
            <button class="view-toggle-btn" data-view="market" onclick="setView('market')">üéØ Market View</button>
        </div>
        
        <header>
            <a href="index.html" class="back-btn" id="back-link">‚Üê Back</a>
            <div class="market-header">
                <h1 id="market-name">Loading...</h1>
                <div class="market-meta" id="market-meta"></div>
            </div>
            <div class="current-value" id="current-value-section">
                <div class="value-display" id="current-value">-</div>
                <div class="change-display" id="current-change">-</div>
            </div>
        </header>
        
        <!-- Data View Content -->
        <div id="data-view-content">
            <div id="prediction-markets" class="prediction-markets"></div>
            
            <div class="chart-controls">
                <div class="control-group">
                    <span class="control-label">Frequency</span>
                    <div class="timeframe-toggle">
                        <button class="timeframe-btn active" data-tf="daily">Daily</button>
                        <button class="timeframe-btn" data-tf="weekly">Weekly</button>
                        <button class="timeframe-btn" data-tf="monthly">Monthly</button>
                    </div>
                </div>
                
                <div class="control-group">
                    <span class="control-label">Range</span>
                    <div class="range-presets">
                        <button class="range-btn" data-range="7D">7D</button>
                        <button class="range-btn active" data-range="30D">30D</button>
                        <button class="range-btn" data-range="90D">90D</button>
                        <button class="range-btn" data-range="1Y">1Y</button>
                        <button class="range-btn" data-range="MAX">MAX</button>
                    </div>
                </div>
                
                <div class="control-group">
                    <span class="control-label">From</span>
                    <div class="date-inputs">
                        <input type="date" class="date-input" id="date-start">
                        <span style="color: #64748b;">to</span>
                        <input type="date" class="date-input" id="date-end">
                    </div>
                </div>
                
                <div class="control-group">
                    <span class="control-label">Normalize</span>
                    <select id="normalize-select">
                        <option value="raw">Raw</option>
                        <option value="index100">Start = 100</option>
                        <option value="pct">% Change</option>
                        <option value="minmax">Min-Max (0-100)</option>
                        <option value="band6m_price">Band 6M (Price 100-900)</option>
                        <option value="band6m_pct">Band 6M (% Move)</option>
                    </select>
                </div>
                
                <div class="band-info" id="band-info"></div>
                <div class="chart-legend" id="chart-legend"></div>
            </div>
            
            <div class="fallback-notice" id="fallback-notice">
                Showing daily data. Weekly/monthly data not available for this market.
            </div>
            
            <div class="chart-section">
                <div class="chart-container">
                    <canvas id="priceChart"></canvas>
                </div>
            </div>
            
            <!-- YES% Chart Section -->
            <div class="chart-section yes-section">
                <div class="yes-controls">
                    <span class="control-label">YES% Band</span>
                    <div class="yes-band-toggle">
                        <button class="yes-band-btn active" data-band="6M">6M</button>
                        <button class="yes-band-btn" data-band="1Y">1Y</button>
                        <button class="yes-band-btn" data-band="2Y">2Y</button>
                    </div>
                    <span class="control-label">Range</span>
                    <div class="yes-range-toggle">
                        <button class="yes-range-btn" data-range="1M">1M</button>
                        <button class="yes-range-btn active" data-range="6M">6M</button>
                        <button class="yes-range-btn" data-range="1Y">1Y</button>
                        <button class="yes-range-btn" data-range="2Y">2Y</button>
                    </div>
                    <div class="yes-band-info" id="yes-band-info">Band=6M, p5/p95, pad=50%, clamp=2-98%</div>
                </div>
                <div class="chart-container">
                    <canvas id="yesChart"></canvas>
                </div>
            </div>
            
            <div class="data-table-section">
                <div class="section-header">
                    <h2 class="section-title">üìä Historical Data</h2>
                </div>
                <div class="table-container">
                    <table id="data-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Value</th>
                                <th>Change</th>
                                <th>Change %</th>
                            </tr>
                        </thead>
                        <tbody id="table-body">
                            <tr><td colspan="4" class="loading">Loading data...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Market View Content -->
        <div id="market-view-content" style="display: none;">
            <div class="market-view-layout">
                <div class="market-view-main">
                    <div class="market-view-chart-section">
                        <div class="market-view-chart-header">
                            <span class="market-view-chart-title">YES% Probability</span>
                            <span class="yes-badge">üîí 1Y Band</span>
                        </div>
                        
                        <div class="chart-controls" style="margin-bottom: 16px;">
                            <div class="control-group">
                                <span class="control-label">Frequency</span>
                                <div class="timeframe-toggle">
                                    <button class="timeframe-btn active" data-tf="daily" id="mv-daily">Daily</button>
                                    <button class="timeframe-btn" data-tf="weekly" id="mv-weekly">Weekly</button>
                                    <button class="timeframe-btn" data-tf="monthly" id="mv-monthly">Monthly</button>
                                </div>
                            </div>
                            
                            <div class="control-group">
                                <span class="control-label">Range</span>
                                <div class="range-presets">
                                    <button class="range-btn" data-range="7D" id="mv-7d">7D</button>
                                    <button class="range-btn active" data-range="30D" id="mv-30d">30D</button>
                                    <button class="range-btn" data-range="90D" id="mv-90d">90D</button>
                                    <button class="range-btn" data-range="1Y" id="mv-1y">1Y</button>
                                    <button class="range-btn" data-range="MAX" id="mv-max">MAX</button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="chart-container" style="height: 450px;">
                            <canvas id="marketViewChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Fake Polymarket Trade Panel -->
                <div class="trade-panel">
                    <div class="trade-panel-header">
                        <button class="trade-panel-tab buy active" onclick="setTradeMode('buy')">Buy</button>
                        <button class="trade-panel-tab sell" onclick="setTradeMode('sell')">Sell</button>
                    </div>
                    
                    <div class="outcome-tabs">
                        <button class="outcome-tab yes active" onclick="setOutcome('yes')">Yes</button>
                        <button class="outcome-tab no" onclick="setOutcome('no')">No</button>
                    </div>
                    
                    <div class="price-display">
                        <div class="price-label">Price</div>
                        <div class="price-value yes" id="trade-price">65.4¬¢</div>
                    </div>
                    
                    <div class="input-group">
                        <div class="input-label">
                            <span>Shares</span>
                            <span id="shares-value">0</span>
                        </div>
                        <input type="number" class="input-field" id="shares-input" placeholder="0" min="0" step="1" oninput="updateTradeAmounts()">
                    </div>
                    
                    <div class="input-group">
                        <div class="input-label">
                            <span>Amount ($)</span>
                            <span id="amount-value">$0.00</span>
                        </div>
                        <input type="number" class="input-field" id="amount-input" placeholder="0.00" min="0" step="0.01" oninput="updateTradeShares()">
                    </div>
                    
                    <button class="trade-cta buy-yes" id="trade-cta" disabled>Buy YES</button>
                    
                    <div class="demo-notice">
                        ‚ö†Ô∏è Trading disabled (demo UI)
                    </div>
                    
                    <div class="trade-stats">
                        <div class="trade-stat">
                            <div class="trade-stat-label">Potential Return</div>
                            <div class="trade-stat-value" id="potential-return">$0.00</div>
                        </div>
                        <div class="trade-stat">
                            <div class="trade-stat-label">Max Payout</div>
                            <div class="trade-stat-value" id="max-payout">$0.00</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Global error handler
        window.onerror = function(msg, url, line, col, error) {
            console.error('Global error:', msg, 'at line', line, 'col', col);
            document.getElementById('market-name').textContent = 'JS Error: ' + msg + ' (line ' + line + ')';
            return false;
        };
        
        // Get market from URL
        const urlParams = new URLSearchParams(window.location.search);
        const marketName = urlParams.get('market');
        const urlOutcome = urlParams.get('outcome');
        
        let marketData = null;
        let chartInstance = null;
        let fullSeries = [];
        let currentView = 'data';
        
        // Current state
        let state = {
            timeframe: 'daily',
            rangePreset: '30D',
            startDate: null,
            endDate: null,
            normalize: 'raw'
        };
        
        let currentBandInfo = null;
        let yesChartInstance = null;
        let yesBandState = '6M';
        let yesRangeState = '6M';
        
        // Market View state
        let marketViewChart = null;
        let marketViewState = {
            timeframe: 'daily',
            rangePreset: '30D'
        };
        
        // Trade panel state
        let tradeMode = 'buy';
        let tradeOutcome = urlOutcome || 'yes';
        let yesPrice = 50;
        
        // Prediction market mappings
        const predictionMarkets = {
            'jobless_claims': { kalshi: [{ name: 'Jobless Claims', url: 'https://kalshi.com/markets' }], polymarket: null },
            'mortgage_30y': { kalshi: [{ name: 'Economic Indicators', url: 'https://kalshi.com/markets' }], polymarket: null },
            'nfl_stats': { kalshi: [{ name: 'NFL Markets', url: 'https://kalshi.com/markets' }], polymarket: [{ name: 'NFL', url: 'https://polymarket.com/sports/nfl' }] },
            'box_office': { kalshi: null, polymarket: [{ name: 'Box Office', url: 'https://polymarket.com/entertainment/box-office' }] },
            'cpi_core': { kalshi: [{ name: 'CPI Markets', url: 'https://kalshi.com/markets' }], polymarket: [{ name: 'CPI', url: 'https://polymarket.com/economics' }] },
            'nonfarm_payrolls': { kalshi: [{ name: 'NFP Markets', url: 'https://kalshi.com/markets' }], polymarket: [{ name: 'Nonfarm Payrolls', url: 'https://polymarket.com/economics' }] },
            'fed_funds': { kalshi: [{ name: 'Fed Rate Markets', url: 'https://kalshi.com/markets' }], polymarket: [{ name: 'Fed Rate', url: 'https://polymarket.com/economics' }] },
            'sp500': { kalshi: [{ name: 'S&P 500 Markets', url: 'https://kalshi.com/markets' }], polymarket: [{ name: 'S&P 500', url: 'https://polymarket.com/finance' }] },
            'treasury_10y': { kalshi: [{ name: 'Treasury Markets', url: 'https://kalshi.com/markets' }], polymarket: [{ name: 'Treasury Yield', url: 'https://polymarket.com/finance' }] },
            'consumer_sentiment': { kalshi: [{ name: 'Consumer Sentiment', url: 'https://kalshi.com/markets' }], polymarket: null },
            'vix': { kalshi: [{ name: 'VIX Markets', url: 'https://kalshi.com/markets' }], polymarket: [{ name: 'VIX', url: 'https://polymarket.com/finance' }] },
            'dow_jones': { kalshi: [{ name: 'Dow Jones Markets', url: 'https://kalshi.com/markets' }], polymarket: [{ name: 'Dow Jones', url: 'https://polymarket.com/finance' }] },
            'nasdaq': { kalshi: [{ name: 'NASDAQ Markets', url: 'https://kalshi.com/markets' }], polymarket: [{ name: 'NASDAQ', url: 'https://polymarket.com/finance' }] },
            'bitcoin': { kalshi: [{ name: 'Bitcoin Markets', url: 'https://kalshi.com/markets' }], polymarket: [{ name: 'Bitcoin', url: 'https://polymarket.com/crypto' }] },
            'ethereum': { kalshi: [{ name: 'Ethereum Markets', url: 'https://kalshi.com/markets' }], polymarket: [{ name: 'Ethereum', url: 'https://polymarket.com/crypto' }] },
            'unemployment_rate': { kalshi: [{ name: 'Unemployment Rate', url: 'https://kalshi.com/markets' }], polymarket: [{ name: 'Unemployment', url: 'https://polymarket.com/economics' }] },
            'cpi': { kalshi: [{ name: 'CPI Markets', url: 'https://kalshi.com/markets' }], polymarket: [{ name: 'CPI', url: 'https://polymarket.com/economics' }] },
            'gdp': { kalshi: [{ name: 'GDP Markets', url: 'https://kalshi.com/markets' }], polymarket: [{ name: 'GDP', url: 'https://polymarket.com/economics' }] }
        };
        
        // Get view from URL or localStorage
        function getInitialView() {
            const urlView = urlParams.get('view');
            if (urlView === 'market' || urlView === 'data') {
                return urlView;
            }
            const storedView = localStorage.getItem('oddodd-view');
            if (storedView === 'market' || storedView === 'data') {
                return storedView;
            }
            return 'data';
        }
        
        // Set view
        function setView(view) {
            currentView = view;
            localStorage.setItem('oddodd-view', view);
            
            // Update URL
            const url = new URL(window.location);
            url.searchParams.set('view', view);
            window.history.replaceState({}, '', url);
            
            // Update toggle buttons
            document.querySelectorAll('.view-toggle-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === view);
            });
            
            // Show/hide content
            document.getElementById('data-view-content').style.display = view === 'data' ? 'block' : 'none';
            document.getElementById('market-view-content').style.display = view === 'market' ? 'block' : 'none';
            
            // Update back link
            document.getElementById('back-link').href = `index.html?view=${view}`;
            
            // Update header for market view
            const currentValueSection = document.getElementById('current-value-section');
            if (view === 'market') {
                currentValueSection.style.display = 'none';
                updateMarketViewChart();
                updateTradePanel();
            } else {
                currentValueSection.style.display = 'block';
                updateChart();
            }
        }
        
        // Aggregate data by timeframe
        function aggregateData(data, timeframe) {
            if (!data || data.length === 0) return [];
            if (timeframe === 'daily') return data;
            
            const aggregated = [];
            let currentGroup = null;
            let currentValues = [];
            
            data.forEach(point => {
                const date = new Date(point.t);
                let groupKey;
                
                if (timeframe === 'weekly') {
                    const weekStart = new Date(date);
                    weekStart.setDate(date.getDate() - date.getDay());
                    groupKey = weekStart.toISOString().split('T')[0];
                } else if (timeframe === 'monthly') {
                    groupKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                }
                
                if (groupKey !== currentGroup) {
                    if (currentValues.length > 0) {
                        const avgValue = currentValues.reduce((a, b) => a + b, 0) / currentValues.length;
                        aggregated.push({ t: new Date(currentGroup), v: avgValue });
                    }
                    currentGroup = groupKey;
                    currentValues = [];
                }
                
                currentValues.push(point.v);
            });
            
            if (currentValues.length > 0) {
                const avgValue = currentValues.reduce((a, b) => a + b, 0) / currentValues.length;
                aggregated.push({ t: new Date(currentGroup), v: avgValue });
            }
            
            return aggregated;
        }
        
        // Calculate YES% for market view
        function calculateYesPercent(value, band) {
            if (!band || band.hi === band.lo) return 50;
            const s = (value - band.lo) / (band.hi - band.lo);
            const clamped = Math.max(0, Math.min(1, s));
            const p = Math.max(0.02, Math.min(0.98, clamped));
            return 100 * p;
        }
        
        // Update Market View Chart (YES% only, 1Y band locked)
        function updateMarketViewChart() {
            if (!fullSeries || fullSeries.length === 0) return;
            
            // Aggregate by timeframe
            let series = aggregateData(fullSeries, marketViewState.timeframe);
            
            // Filter by range
            const toDate = series.length > 0 ? series[series.length - 1].t : null;
            let startDate = null;
            if (toDate && marketViewState.rangePreset !== 'MAX') {
                startDate = new Date(toDate);
                const days = ChartUtils.RANGE_PRESETS[marketViewState.rangePreset];
                if (days) startDate.setDate(startDate.getDate() - days);
            }
            
            series = ChartUtils.filterByRange(series, startDate, toDate);
            if (series.length === 0) return;
            
            // Compute 1Y band (locked)
            const band = ChartUtils.computeYesBand(fullSeries, '1Y', toDate);
            if (!band) return;
            
            // Update YES price for trade panel
            const latestValue = series[series.length - 1].v;
            yesPrice = calculateYesPercent(latestValue, band);
            updateTradePanel();
            
            // Convert to YES%
            const yesData = series.map(p => ({
                t: p.t,
                v: calculateYesPercent(p.v, band),
                raw: p.v
            }));
            
            const labels = yesData.map(p => p.t.toISOString().split('T')[0]);
            const values = yesData.map(p => p.v);
            
            const ctx = document.getElementById('marketViewChart').getContext('2d');
            
            if (marketViewChart) {
                marketViewChart.data.labels = labels;
                marketViewChart.data.datasets[0].data = values;
                marketViewChart.update('none');
            } else {
                marketViewChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'YES%',
                            data: values,
                            borderColor: '#4ade80',
                            backgroundColor: 'rgba(74, 222, 128, 0.15)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 0,
                            pointHoverRadius: 6,
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { intersect: false, mode: 'index' },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: '#1e293b',
                                titleColor: '#e2e8f0',
                                bodyColor: '#e2e8f0',
                                borderColor: 'rgba(255,255,255,0.1)',
                                borderWidth: 1,
                                callbacks: {
                                    label: function(context) {
                                        const dataPoint = yesData[context.dataIndex];
                                        return [
                                            `YES%: ${context.parsed.y.toFixed(1)}%`,
                                            `Raw: ${ChartUtils.formatValue(dataPoint.raw, marketData.unit)}`
                                        ];
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: { color: 'rgba(255,255,255,0.05)' },
                                ticks: { color: '#64748b', maxTicksLimit: 8 }
                            },
                            y: {
                                min: 0,
                                max: 100,
                                grid: { color: 'rgba(255,255,255,0.05)' },
                                ticks: {
                                    color: '#64748b',
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }
        
        // Trade panel functions
        function setTradeMode(mode) {
            tradeMode = mode;
            document.querySelectorAll('.trade-panel-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`.trade-panel-tab.${mode}`).classList.add('active');
            updateTradePanel();
        }
        
        function setOutcome(outcome) {
            tradeOutcome = outcome;
            document.querySelectorAll('.outcome-tab').forEach(tab => {
                tab.classList.remove('active', 'yes', 'no');
            });
            const activeTab = document.querySelector(`.outcome-tab.${outcome}`);
            activeTab.classList.add('active', outcome);
            updateTradePanel();
        }
        
        function updateTradePanel() {
            const priceEl = document.getElementById('trade-price');
            const ctaEl = document.getElementById('trade-cta');
            
            // Calculate price (YES% or 100-YES%)
            const displayPrice = tradeOutcome === 'yes' ? yesPrice : (100 - yesPrice);
            priceEl.textContent = displayPrice.toFixed(1) + '¬¢';
            priceEl.className = 'price-value ' + tradeOutcome;
            
            // Update CTA
            const action = tradeMode === 'buy' ? 'Buy' : 'Sell';
            const outcomeUpper = tradeOutcome.toUpperCase();
            ctaEl.textContent = `${action} ${outcomeUpper}`;
            ctaEl.className = `trade-cta buy-${tradeOutcome}`;
            
            // Update trade calculations
            updateTradeCalculations();
        }
        
        function updateTradeAmounts() {
            const sharesInput = document.getElementById('shares-input');
            const amountInput = document.getElementById('amount-input');
            const shares = parseFloat(sharesInput.value) || 0;
            
            const displayPrice = tradeOutcome === 'yes' ? yesPrice : (100 - yesPrice);
            const pricePerShare = displayPrice / 100;
            const amount = shares * pricePerShare;
            
            amountInput.value = amount > 0 ? amount.toFixed(2) : '';
            updateTradeCalculations();
        }
        
        function updateTradeShares() {
            const sharesInput = document.getElementById('shares-input');
            const amountInput = document.getElementById('amount-input');
            const amount = parseFloat(amountInput.value) || 0;
            
            const displayPrice = tradeOutcome === 'yes' ? yesPrice : (100 - yesPrice);
            const pricePerShare = displayPrice / 100;
            const shares = pricePerShare > 0 ? amount / pricePerShare : 0;
            
            sharesInput.value = shares > 0 ? Math.round(shares) : '';
            updateTradeCalculations();
        }
        
        function updateTradeCalculations() {
            const sharesInput = document.getElementById('shares-input');
            const amountInput = document.getElementById('amount-input');
            const shares = parseFloat(sharesInput.value) || 0;
            const amount = parseFloat(amountInput.value) || 0;
            
            document.getElementById('shares-value').textContent = shares.toFixed(0);
            document.getElementById('amount-value').textContent = '$' + amount.toFixed(2);
            
            // Potential return (if outcome wins)
            const potentialReturn = shares > 0 ? shares - amount : 0;
            document.getElementById('potential-return').textContent = '$' + potentialReturn.toFixed(2);
            
            // Max payout (if outcome wins)
            document.getElementById('max-payout').textContent = '$' + shares.toFixed(2);
        }
        
        // Update chart (Data View)
        function updateChart() {
            if (!fullSeries || fullSeries.length === 0) return;
            
            let series = aggregateData(fullSeries, state.timeframe);
            series = ChartUtils.filterByRange(series, state.startDate, state.endDate);
            
            if (series.length === 0) return;
            
            const toDate = state.endDate || (series.length > 0 ? series[series.length - 1].t : null);
            
            let normResult = ChartUtils.normalize(series, state.normalize, fullSeries, toDate);
            series = normResult.series;
            currentBandInfo = normResult.bandInfo;
            
            const bandInfoEl = document.getElementById('band-info');
            if (currentBandInfo) {
                bandInfoEl.textContent = ChartUtils.formatBandInfo(currentBandInfo);
                bandInfoEl.style.display = 'block';
            } else {
                bandInfoEl.textContent = '';
                bandInfoEl.style.display = 'none';
            }
            
            const normLabel = {
                'raw': 'Raw', 'index100': 'Start=100', 'pct': '% Change',
                'minmax': 'Min-Max', 'band6m_price': 'Band 6M (Price)', 'band6m_pct': 'Band 6M (%)'
            }[state.normalize];
            
            document.getElementById('chart-legend').textContent = 
                `${marketData.display_name} (${normLabel}, ${state.rangePreset || 'Custom'})`;
            
            const labels = series.map(p => p.t.toISOString().split('T')[0]);
            const values = series.map(p => p.v);
            
            const ctx = document.getElementById('priceChart').getContext('2d');
            const color = values.length > 1 && values[values.length - 1] >= values[0] ? '#4ade80' : '#f87171';
            
            if (chartInstance) {
                chartInstance.data.labels = labels;
                chartInstance.data.datasets[0].data = values;
                chartInstance.data.datasets[0].borderColor = color;
                chartInstance.data.datasets[0].backgroundColor = color + '20';
                chartInstance.update('none');
            } else {
                chartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: marketData.display_name,
                            data: values,
                            borderColor: color,
                            backgroundColor: color + '20',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 0,
                            pointHoverRadius: 6,
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { intersect: false, mode: 'index' },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: '#1e293b',
                                titleColor: '#e2e8f0',
                                bodyColor: '#e2e8f0',
                                borderColor: 'rgba(255,255,255,0.1)',
                                borderWidth: 1,
                                callbacks: {
                                    label: function(context) {
                                        const dataPoint = series[context.dataIndex];
                                        let label = '';
                                        if (currentBandInfo && dataPoint.raw !== undefined) {
                                            label += `Raw: ${ChartUtils.formatValue(dataPoint.raw, marketData.unit)} | `;
                                        }
                                        label += ChartUtils.formatValue(context.parsed.y, currentBandInfo ? 'index' : marketData.unit);
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: { color: 'rgba(255,255,255,0.05)' },
                                ticks: { color: '#64748b', maxTicksLimit: 8 }
                            },
                            y: {
                                grid: { color: 'rgba(255,255,255,0.05)' },
                                ticks: {
                                    color: '#64748b',
                                    callback: function(value) {
                                        return ChartUtils.formatValue(value, currentBandInfo ? 'index' : marketData.unit);
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            updateTable(series);
            updateYesChart();
        }
        
        // Update YES% chart (Data View)
        function updateYesChart() {
            if (!fullSeries || fullSeries.length === 0) return;
            
            let series = aggregateData(fullSeries, state.timeframe);
            
            const toDate = series.length > 0 ? series[series.length - 1].t : null;
            let startDate = null;
            if (toDate) {
                startDate = new Date(toDate);
                switch(yesRangeState) {
                    case '1M': startDate.setMonth(startDate.getMonth() - 1); break;
                    case '1Y': startDate.setFullYear(startDate.getFullYear() - 1); break;
                    case '2Y': startDate.setFullYear(startDate.getFullYear() - 2); break;
                    case '6M': default: startDate.setMonth(startDate.getMonth() - 6); break;
                }
            }
            
            series = ChartUtils.filterByRange(series, startDate, toDate);
            if (series.length === 0) return;
            
            const band = ChartUtils.computeYesBand(fullSeries, yesBandState, toDate);
            if (!band) return;
            
            const bandInfoEl = document.getElementById('yes-band-info');
            const fallbackText = band.band !== band.requestedBand ? ` (fallback: ${band.band})` : '';
            bandInfoEl.textContent = `Band=${band.requestedBand}${fallbackText}, p5=${band.p5.toFixed(2)}, p95=${band.p95.toFixed(2)}, pad=50%, lo=${band.lo.toFixed(2)}, hi=${band.hi.toFixed(2)}, clamp=2-98%`;
            
            const yesData = series.map(p => ({
                t: p.t,
                v: calculateYesPercent(p.v, band)
            }));
            
            const labels = yesData.map(p => p.t.toISOString().split('T')[0]);
            const values = yesData.map(p => p.v);
            
            const ctx = document.getElementById('yesChart').getContext('2d');
            
            if (yesChartInstance) {
                yesChartInstance.data.labels = labels;
                yesChartInstance.data.datasets[0].data = values;
                yesChartInstance.update('none');
            } else {
                yesChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'YES%',
                            data: values,
                            borderColor: '#4ade80',
                            backgroundColor: 'rgba(74, 222, 128, 0.2)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 0,
                            pointHoverRadius: 6,
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { intersect: false, mode: 'index' },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: '#1e293b',
                                titleColor: '#e2e8f0',
                                bodyColor: '#e2e8f0',
                                borderColor: 'rgba(255,255,255,0.1)',
                                borderWidth: 1,
                                callbacks: {
                                    label: function(context) {
                                        return 'YES%: ' + context.parsed.y.toFixed(1) + '%';
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: { color: 'rgba(255,255,255,0.05)' },
                                ticks: { color: '#64748b', maxTicksLimit: 8 }
                            },
                            y: {
                                min: 0,
                                max: 100,
                                grid: { color: 'rgba(255,255,255,0.05)' },
                                ticks: {
                                    color: '#64748b',
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }
        
        // Update table
        function updateTable(series) {
            const tbody = document.getElementById('table-body');
            
            if (!series || series.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="loading">No data available</td></tr>';
                return;
            }
            
            const reversed = [...series].reverse();
            
            let html = '';
            reversed.forEach((row, index) => {
                const prevRow = reversed[index + 1];
                const currentVal = row.raw !== undefined ? row.raw : row.v;
                const prevVal = prevRow ? (prevRow.raw !== undefined ? prevRow.raw : prevRow.v) : null;
                
                const change = prevVal !== null ? currentVal - prevVal : null;
                const changePercent = prevVal !== null ? ((currentVal - prevVal) / prevVal * 100) : null;
                
                let changeText = '-';
                let changeClass = 'neutral';
                let changePctText = '-';
                
                if (change !== null) {
                    changeText = (change > 0 ? '+' : '') + ChartUtils.formatValue(change, marketData.unit);
                    changeClass = change > 0 ? 'positive' : change < 0 ? 'negative' : 'neutral';
                    changePctText = (changePercent > 0 ? '+' : '') + changePercent.toFixed(2) + '%';
                }
                
                const dateStr = row.t.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
                
                let valueDisplay = ChartUtils.formatValue(currentVal, marketData.unit);
                if (currentBandInfo && row.v !== currentVal) {
                    valueDisplay += ` (${ChartUtils.formatValue(row.v, 'index')})`;
                }
                
                html += `
                    <tr>
                        <td>${dateStr}</td>
                        <td class="cell-value">${valueDisplay}</td>
                        <td class="cell-change ${changeClass}">${changeText}</td>
                        <td class="cell-change ${changeClass}">${changePctText}</td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }
        
        // Set range preset
        function setRangePreset(preset) {
            state.rangePreset = preset;
            
            if (preset === 'MAX') {
                state.startDate = null;
                state.endDate = null;
            } else {
                const days = ChartUtils.RANGE_PRESETS[preset];
                if (days && fullSeries.length > 0) {
                    const end = fullSeries[fullSeries.length - 1].t;
                    const start = new Date(end);
                    start.setDate(start.getDate() - days);
                    state.startDate = start.toISOString().split('T')[0];
                    state.endDate = end.toISOString().split('T')[0];
                }
            }
            
            document.getElementById('date-start').value = state.startDate || '';
            document.getElementById('date-end').value = state.endDate || '';
            
            document.querySelectorAll('.range-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.range === preset);
            });
            
            updateChart();
        }
        
        // Set YES% band
        function setYesBand(band) {
            yesBandState = band;
            document.querySelectorAll('.yes-band-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.band === band);
            });
            updateYesChart();
        }
        
        // Set YES% range
        function setYesRange(range) {
            yesRangeState = range;
            document.querySelectorAll('.yes-range-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.range === range);
            });
            updateYesChart();
        }
        
        // Set Market View range
        function setMarketViewRange(preset) {
            marketViewState.rangePreset = preset;
            
            document.querySelectorAll('#market-view-content .range-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.range === preset);
            });
            
            updateMarketViewChart();
        }
        
        // Set Market View timeframe
        function setMarketViewTimeframe(tf) {
            marketViewState.timeframe = tf;
            
            document.querySelectorAll('#market-view-content .timeframe-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tf === tf);
            });
            
            updateMarketViewChart();
        }
        
        // Load market data
        async function loadMarketData() {
            try {
                const response = await fetch('data/latest.json');
                if (!response.ok) throw new Error('Failed to load data');
                
                const data = await response.json();
                marketData = data.markets.find(m => m.name === marketName);
                
                if (!marketData) {
                    document.getElementById('market-name').textContent = 'Market not found';
                    return;
                }
                
                document.getElementById('market-name').textContent = marketData.display_name;
                document.getElementById('market-meta').textContent = `${marketData.category} ‚Ä¢ ${marketData.data_source}`;
                document.getElementById('current-value').textContent = ChartUtils.formatValue(marketData.latest_value, marketData.unit);
                
                const change = marketData.change_absolute;
                const changeClass = change > 0 ? 'positive' : change < 0 ? 'negative' : 'neutral';
                const changeText = change > 0 ? '‚ñ≤ +' : change < 0 ? '‚ñº ' : '‚àí ';
                const changeEl = document.getElementById('current-change');
                changeEl.textContent = changeText + ChartUtils.formatValue(Math.abs(change), marketData.unit) + 
                    ' (' + (marketData.change_percent > 0 ? '+' : '') + marketData.change_percent.toFixed(2) + '%)';
                changeEl.className = `change-display ${changeClass}`;
                
                fullSeries = ChartUtils.parseSeries(marketData.history);
                
                if (fullSeries.length > 0) {
                    const end = fullSeries[fullSeries.length - 1].t;
                    const start = new Date(end);
                    start.setDate(start.getDate() - 30);
                    document.getElementById('date-end').value = end.toISOString().split('T')[0];
                    document.getElementById('date-start').value = start.toISOString().split('T')[0];
                }
                
                const pm = predictionMarkets[marketData.name];
                if (pm) {
                    let pmHtml = '';
                    if (pm.kalshi) {
                        pm.kalshi.forEach(m => {
                            pmHtml += `<a href="${m.url}" target="_blank" class="pm-button pm-kalshi">üü¢ ${m.name}</a>`;
                        });
                    }
                    if (pm.polymarket) {
                        pm.polymarket.forEach(m => {
                            pmHtml += `<a href="${m.url}" target="_blank" class="pm-button pm-polymarket">üîµ ${m.name}</a>`;
                        });
                    }
                    document.getElementById('prediction-markets').innerHTML = pmHtml;
                }
                
                // Set initial view
                currentView = getInitialView();
                document.querySelectorAll('.view-toggle-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.view === currentView);
                });
                
                setView(currentView);
                
                if (currentView === 'data') {
                    setRangePreset('30D');
                }
                
            } catch (error) {
                console.error(error);
                document.getElementById('market-name').textContent = 'Error loading data';
            }
        }
        
        // Event listeners - Data View
        document.querySelectorAll('#data-view-content [data-tf]').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('#data-view-content [data-tf]').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                state.timeframe = btn.dataset.tf;
                updateChart();
            });
        });
        
        document.querySelectorAll('#data-view-content [data-range]').forEach(btn => {
            btn.addEventListener('click', () => {
                setRangePreset(btn.dataset.range);
            });
        });
        
        document.getElementById('date-start').addEventListener('change', ChartUtils.debounce((e) => {
            state.startDate = e.target.value || null;
            state.rangePreset = null;
            document.querySelectorAll('#data-view-content .range-btn').forEach(b => b.classList.remove('active'));
            updateChart();
        }, 300));
        
        document.getElementById('date-end').addEventListener('change', ChartUtils.debounce((e) => {
            state.endDate = e.target.value || null;
            state.rangePreset = null;
            document.querySelectorAll('#data-view-content .range-btn').forEach(b => b.classList.remove('active'));
            updateChart();
        }, 300));
        
        document.getElementById('normalize-select').addEventListener('change', (e) => {
            state.normalize = e.target.value;
            updateChart();
        });
        
        document.querySelectorAll('.yes-band-btn').forEach(btn => {
            btn.addEventListener('click', () => setYesBand(btn.dataset.band));
        });
        
        document.querySelectorAll('.yes-range-btn').forEach(btn => {
            btn.addEventListener('click', () => setYesRange(btn.dataset.range));
        });
        
        // Event listeners - Market View
        document.getElementById('mv-daily').addEventListener('click', () => setMarketViewTimeframe('daily'));
        document.getElementById('mv-weekly').addEventListener('click', () => setMarketViewTimeframe('weekly'));
        document.getElementById('mv-monthly').addEventListener('click', () => setMarketViewTimeframe('monthly'));
        
        document.getElementById('mv-7d').addEventListener('click', () => setMarketViewRange('7D'));
        document.getElementById('mv-30d').addEventListener('click', () => setMarketViewRange('30D'));
        document.getElementById('mv-90d').addEventListener('click', () => setMarketViewRange('90D'));
        document.getElementById('mv-1y').addEventListener('click', () => setMarketViewRange('1Y'));
        document.getElementById('mv-max').addEventListener('click', () => setMarketViewRange('MAX'));
        
        // Load data
        loadMarketData();
    </script>
</body>
</html>