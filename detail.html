<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Detail - OddOdd</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="chart-utils.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #e2e8f0;
            line-height: 1.6;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 20px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 30px;
        }
        
        .back-btn {
            background: rgba(96, 165, 250, 0.2);
            border: 1px solid rgba(96, 165, 250, 0.3);
            color: #60a5fa;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .back-btn:hover {
            background: rgba(96, 165, 250, 0.3);
        }
        
        .market-header {
            flex: 1;
        }
        
        h1 {
            font-size: 1.8rem;
            background: linear-gradient(135deg, #60a5fa, #a78bfa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .market-meta {
            color: #64748b;
            font-size: 0.9rem;
            margin-top: 5px;
        }
        
        .current-value {
            text-align: right;
        }
        
        .value-display {
            font-size: 2.5rem;
            font-weight: 700;
            color: #f8fafc;
            font-family: 'SF Mono', Monaco, monospace;
        }
        
        .change-display {
            font-size: 1.1rem;
            font-weight: 600;
            margin-top: 5px;
        }
        
        .change-display.positive { color: #4ade80; }
        .change-display.negative { color: #f87171; }
        .change-display.neutral { color: #94a3b8; }
        
        /* Chart Controls */
        .chart-controls {
            background: rgba(30, 41, 59, 0.8);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            align-items: center;
        }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .control-label {
            font-size: 0.85rem;
            color: #94a3b8;
            font-weight: 500;
        }
        
        .timeframe-toggle {
            display: flex;
            gap: 4px;
            background: rgba(15, 23, 42, 0.5);
            padding: 4px;
            border-radius: 8px;
        }
        
        .timeframe-btn {
            background: transparent;
            border: none;
            color: #94a3b8;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }
        
        .timeframe-btn:hover { color: #e2e8f0; }
        .timeframe-btn.active {
            background: rgba(96, 165, 250, 0.2);
            color: #60a5fa;
        }
        
        .range-presets {
            display: flex;
            gap: 4px;
        }
        
        .range-btn {
            background: rgba(15, 23, 42, 0.5);
            border: 1px solid rgba(255,255,255,0.1);
            color: #94a3b8;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s;
        }
        
        .range-btn:hover { color: #e2e8f0; border-color: rgba(255,255,255,0.2); }
        .range-btn.active {
            background: rgba(96, 165, 250, 0.2);
            color: #60a5fa;
            border-color: rgba(96, 165, 250, 0.3);
        }
        
        .date-inputs {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .date-input {
            background: rgba(15, 23, 42, 0.5);
            border: 1px solid rgba(255,255,255,0.1);
            color: #e2e8f0;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-family: inherit;
        }
        
        .date-input:focus {
            outline: none;
            border-color: rgba(96, 165, 250, 0.5);
        }
        
        select {
            background: rgba(15, 23, 42, 0.5);
            border: 1px solid rgba(255,255,255,0.1);
            color: #e2e8f0;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-family: inherit;
            cursor: pointer;
        }
        
        select:focus {
            outline: none;
            border-color: rgba(96, 165, 250, 0.5);
        }
        
        .chart-legend {
            font-size: 0.85rem;
            color: #94a3b8;
            margin-left: auto;
        }
        
        .band-info {
            font-size: 0.8rem;
            color: #64748b;
            background: rgba(15, 23, 42, 0.5);
            padding: 6px 12px;
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.05);
            font-family: 'SF Mono', Monaco, monospace;
        }
        
        .band-info:empty { display: none; }
        
        /* Chart Section */
        .chart-section {
            background: rgba(30, 41, 59, 0.8);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 30px;
        }
        
        .chart-container {
            position: relative;
            height: 400px;
        }
        
        .fallback-notice {
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid rgba(251, 191, 36, 0.3);
            color: #fbbf24;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 0.85rem;
            margin-bottom: 16px;
            display: none;
        }
        
        .fallback-notice.visible { display: block; }
        
        /* Data Table */
        .data-table-section {
            background: rgba(30, 41, 59, 0.8);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .section-title {
            font-size: 1.2rem;
            color: #e2e8f0;
        }
        
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        
        th {
            color: #94a3b8;
            font-weight: 500;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        td { color: #e2e8f0; }
        tr:hover { background: rgba(96, 165, 250, 0.05); }
        
        .cell-value {
            font-family: 'SF Mono', Monaco, monospace;
            font-weight: 600;
        }
        
        .cell-change { text-align: right; }
        .cell-change.positive { color: #4ade80; }
        .cell-change.negative { color: #f87171; }
        
        /* Prediction Markets */
        .prediction-markets {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .pm-button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            border-radius: 8px;
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .pm-button:hover { transform: translateY(-2px); }
        
        .pm-kalshi {
            background: rgba(74, 222, 128, 0.15);
            color: #4ade80;
            border: 1px solid rgba(74, 222, 128, 0.3);
        }
        .pm-kalshi:hover { background: rgba(74, 222, 128, 0.25); }
        
        .pm-polymarket {
            background: rgba(96, 165, 250, 0.15);
            color: #60a5fa;
            border: 1px solid rgba(96, 165, 250, 0.3);
        }
        .pm-polymarket:hover { background: rgba(96, 165, 250, 0.25); }
        
        @media (max-width: 768px) {
            .value-display { font-size: 1.8rem; }
            .chart-container { height: 300px; }
            .chart-controls { flex-direction: column; align-items: stretch; }
            .control-group { justify-content: space-between; }
            .chart-legend { margin-left: 0; text-align: center; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <a href="index.html" class="back-btn">‚Üê Back</a>
            <div class="market-header">
                <h1 id="market-name">Loading...</h1>
                <div class="market-meta" id="market-meta"></div>
            </div>
            <div class="current-value">
                <div class="value-display" id="current-value">-</div>
                <div class="change-display" id="current-change">-</div>
            </div>
        </header>
        
        <div id="prediction-markets" class="prediction-markets"></div>
        
        <div class="chart-controls">
            <div class="control-group">
                <span class="control-label">Frequency</span>
                <div class="timeframe-toggle">
                    <button class="timeframe-btn active" data-tf="daily">Daily</button>
                    <button class="timeframe-btn" data-tf="weekly">Weekly</button>
                    <button class="timeframe-btn" data-tf="monthly">Monthly</button>
                </div>
            </div>
            
            <div class="control-group">
                <span class="control-label">Range</span>
                <div class="range-presets">
                    <button class="range-btn" data-range="7D">7D</button>
                    <button class="range-btn active" data-range="30D">30D</button>
                    <button class="range-btn" data-range="90D">90D</button>
                    <button class="range-btn" data-range="1Y">1Y</button>
                    <button class="range-btn" data-range="MAX">MAX</button>
                </div>
            </div>
            
            <div class="control-group">
                <span class="control-label">From</span>
                <div class="date-inputs">
                    <input type="date" class="date-input" id="date-start">
                    <span style="color: #64748b;">to</span>
                    <input type="date" class="date-input" id="date-end">
                </div>
            </div>
            
            <div class="control-group">
                <span class="control-label">Normalize</span>
                <select id="normalize-select">
                    <option value="raw">Raw</option>
                    <option value="index100">Start = 100</option>
                    <option value="pct">% Change</option>
                    <option value="minmax">Min-Max (0-100)</option>
                    <option value="band6m_price">Band 6M (Price 100-900)</option>
                    <option value="band6m_pct">Band 6M (% Move)</option>
                </select>
            </div>
            
            <div class="band-info" id="band-info"></div>
        </div>
        
        <div class="fallback-notice" id="fallback-notice">
            Showing daily data. Weekly/monthly data not available for this market.
        </div>
        
        <div class="chart-section">
            <div class="chart-container">
                <canvas id="priceChart"></canvas>
            </div>
        </div>
        
        <div class="data-table-section">
            <div class="section-header">
                <h2 class="section-title">üìä Historical Data</h2>
            </div>
            <div class="table-container">
                <table id="data-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Value</th>
                            <th>Change</th>
                            <th>Change %</th>
                        </tr>
                    </thead>
                    <tbody id="table-body">
                        <tr><td colspan="4" class="loading">Loading data...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <script>
        // Get market from URL
        const urlParams = new URLSearchParams(window.location.search);
        const marketName = urlParams.get('market');
        
        let marketData = null;
        let chartInstance = null;
        let fullSeries = [];
        
        // Current state
        let state = {
            timeframe: 'daily',
            rangePreset: '30D',
            startDate: null,
            endDate: null,
            normalize: 'raw'
        };
        
        let currentBandInfo = null;
        
        // Prediction market mappings
        const predictionMarkets = {
            'jobless_claims': { kalshi: [{ name: 'Jobless Claims', url: 'https://kalshi.com/markets' }], polymarket: null },
            'mortgage_30y': { kalshi: [{ name: 'Economic Indicators', url: 'https://kalshi.com/markets' }], polymarket: null },
            'nfl_stats': { kalshi: [{ name: 'NFL Markets', url: 'https://kalshi.com/markets' }], polymarket: [{ name: 'NFL', url: 'https://polymarket.com/sports/nfl' }] },
            'box_office': { kalshi: null, polymarket: [{ name: 'Box Office', url: 'https://polymarket.com/entertainment/box-office' }] },
            'cpi_core': { kalshi: [{ name: 'CPI Markets', url: 'https://kalshi.com/markets' }], polymarket: [{ name: 'CPI', url: 'https://polymarket.com/economics' }] },
            'nonfarm_payrolls': { kalshi: [{ name: 'NFP Markets', url: 'https://kalshi.com/markets' }], polymarket: [{ name: 'Nonfarm Payrolls', url: 'https://polymarket.com/economics' }] },
            'fed_funds': { kalshi: [{ name: 'Fed Rate Markets', url: 'https://kalshi.com/markets' }], polymarket: [{ name: 'Fed Rate', url: 'https://polymarket.com/economics' }] },
            'sp500': { kalshi: [{ name: 'S&P 500 Markets', url: 'https://kalshi.com/markets' }], polymarket: [{ name: 'S&P 500', url: 'https://polymarket.com/finance' }] },
            'treasury_10y': { kalshi: [{ name: 'Treasury Markets', url: 'https://kalshi.com/markets' }], polymarket: [{ name: 'Treasury Yield', url: 'https://polymarket.com/finance' }] },
            'consumer_sentiment': { kalshi: [{ name: 'Consumer Sentiment', url: 'https://kalshi.com/markets' }], polymarket: null },
            'vix': { kalshi: [{ name: 'VIX Markets', url: 'https://kalshi.com/markets' }], polymarket: [{ name: 'VIX', url: 'https://polymarket.com/finance' }] },
            'dow_jones': { kalshi: [{ name: 'Dow Jones Markets', url: 'https://kalshi.com/markets' }], polymarket: [{ name: 'Dow Jones', url: 'https://polymarket.com/finance' }] },
            'nasdaq': { kalshi: [{ name: 'NASDAQ Markets', url: 'https://kalshi.com/markets' }], polymarket: [{ name: 'NASDAQ', url: 'https://polymarket.com/finance' }] },
            'bitcoin': { kalshi: [{ name: 'Bitcoin Markets', url: 'https://kalshi.com/markets' }], polymarket: [{ name: 'Bitcoin', url: 'https://polymarket.com/crypto' }] },
            'ethereum': { kalshi: [{ name: 'Ethereum Markets', url: 'https://kalshi.com/markets' }], polymarket: [{ name: 'Ethereum', url: 'https://polymarket.com/crypto' }] },
            'unemployment_rate': { kalshi: [{ name: 'Unemployment Rate', url: 'https://kalshi.com/markets' }], polymarket: [{ name: 'Unemployment', url: 'https://polymarket.com/economics' }] },
            'cpi': { kalshi: [{ name: 'CPI Markets', url: 'https://kalshi.com/markets' }], polymarket: [{ name: 'CPI', url: 'https://polymarket.com/economics' }] },
            'gdp': { kalshi: [{ name: 'GDP Markets', url: 'https://kalshi.com/markets' }], polymarket: [{ name: 'GDP', url: 'https://polymarket.com/economics' }] }
        };
        
        // Aggregate data by timeframe
        function aggregateData(data, timeframe) {
            if (!data || data.length === 0) return [];
            if (timeframe === 'daily') return data;
            
            const aggregated = [];
            let currentGroup = null;
            let currentValues = [];
            
            data.forEach(point => {
                const date = new Date(point.t);
                let groupKey;
                
                if (timeframe === 'weekly') {
                    const weekStart = new Date(date);
                    weekStart.setDate(date.getDate() - date.getDay());
                    groupKey = weekStart.toISOString().split('T')[0];
                } else if (timeframe === 'monthly') {
                    groupKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                }
                
                if (groupKey !== currentGroup) {
                    if (currentValues.length > 0) {
                        const avgValue = currentValues.reduce((a, b) => a + b, 0) / currentValues.length;
                        aggregated.push({ t: new Date(currentGroup), v: avgValue });
                    }
                    currentGroup = groupKey;
                    currentValues = [];
                }
                
                currentValues.push(point.v);
            });
            
            if (currentValues.length > 0) {
                const avgValue = currentValues.reduce((a, b) => a + b, 0) / currentValues.length;
                aggregated.push({ t: new Date(currentGroup), v: avgValue });
            }
            
            return aggregated;
        }
        
        // Update chart
        function updateChart() {
            if (!fullSeries || fullSeries.length === 0) return;
            
            // Aggregate by timeframe
            let series = aggregateData(fullSeries, state.timeframe);
            
            // Filter by range
            series = ChartUtils.filterByRange(series, state.startDate, state.endDate);
            
            // Determine "to" date for band calculation (use end of visible range or last data point)
            const toDate = state.endDate || (series.length > 0 ? series[series.length - 1].t : null);
            
            // Normalize
            const normResult = ChartUtils.normalize(series, state.normalize, fullSeries, toDate);
            series = normResult.series;
            currentBandInfo = normResult.bandInfo;
            
            // Update band info display
            const bandInfoEl = document.getElementById('band-info');
            if (currentBandInfo) {
                bandInfoEl.textContent = ChartUtils.formatBandInfo(currentBandInfo);
                bandInfoEl.style.display = 'block';
            } else {
                bandInfoEl.textContent = '';
                bandInfoEl.style.display = 'none';
            }
            
            // Update legend
            const normLabel = {
                'raw': 'Raw',
                'index100': 'Start=100',
                'pct': '% Change',
                'minmax': 'Min-Max',
                'band6m_price': 'Band 6M (Price)',
                'band6m_pct': 'Band 6M (%)'
            }[state.normalize];
            
            const rangeLabel = state.rangePreset || 'Custom';
            document.getElementById('chart-legend').textContent = 
                `${marketData.display_name} (${normLabel}, ${rangeLabel})`;
            
            // Prepare Chart.js data
            const labels = series.map(p => p.t.toISOString().split('T')[0]);
            const values = series.map(p => p.v);
            
            const ctx = document.getElementById('priceChart').getContext('2d');
            
            const color = values.length > 1 && values[values.length - 1] >= values[0] ? '#4ade80' : '#f87171';
            
            if (chartInstance) {
                chartInstance.data.labels = labels;
                chartInstance.data.datasets[0].data = values;
                chartInstance.data.datasets[0].borderColor = color;
                chartInstance.data.datasets[0].backgroundColor = color + '20';
                chartInstance.update('none');
            } else {
                chartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: marketData.display_name,
                            data: values,
                            borderColor: color,
                            backgroundColor: color + '20',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 0,
                            pointHoverRadius: 6,
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: '#1e293b',
                                titleColor: '#e2e8f0',
                                bodyColor: '#e2e8f0',
                                borderColor: 'rgba(255,255,255,0.1)',
                                borderWidth: 1,
                                callbacks: {
                                    label: function(context) {
                                        const dataPoint = series[context.dataIndex];
                                        let label = '';
                                        
                                        // Show raw value for band modes
                                        if (currentBandInfo && dataPoint.raw !== undefined) {
                                            label += `Raw: ${ChartUtils.formatValue(dataPoint.raw, marketData.unit)} | `;
                                        }
                                        
                                        // Show normalized value
                                        label += ChartUtils.formatValue(context.parsed.y, 
                                            currentBandInfo ? 'index' : marketData.unit);
                                        
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: { color: 'rgba(255,255,255,0.05)' },
                                ticks: { color: '#64748b', maxTicksLimit: 8 }
                            },
                            y: {
                                grid: { color: 'rgba(255,255,255,0.05)' },
                                ticks: {
                                    color: '#64748b',
                                    callback: function(value) {
                                        return ChartUtils.formatValue(value, 
                                            currentBandInfo ? 'index' : marketData.unit);
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // Update table
            updateTable(series);
        }
        
        // Update table
        function updateTable(series) {
            const tbody = document.getElementById('table-body');
            
            if (!series || series.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="loading">No data available</td></tr>';
                return;
            }
            
            const reversed = [...series].reverse();
            
            let html = '';
            reversed.forEach((row, index) => {
                const prevRow = reversed[index + 1];
                
                // Use raw value if available (for band modes), otherwise use normalized value
                const currentVal = row.raw !== undefined ? row.raw : row.v;
                const prevVal = prevRow ? (prevRow.raw !== undefined ? prevRow.raw : prevRow.v) : null;
                
                const change = prevVal !== null ? currentVal - prevVal : null;
                const changePercent = prevVal !== null ? ((currentVal - prevVal) / prevVal * 100) : null;
                
                let changeText = '-';
                let changeClass = 'neutral';
                let changePctText = '-';
                
                if (change !== null) {
                    changeText = (change > 0 ? '+' : '') + ChartUtils.formatValue(change, marketData.unit);
                    changeClass = change > 0 ? 'positive' : change < 0 ? 'negative' : 'neutral';
                    changePctText = (changePercent > 0 ? '+' : '') + changePercent.toFixed(2) + '%';
                }
                
                const dateStr = row.t.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
                
                // Show both raw and normalized for band modes
                let valueDisplay = ChartUtils.formatValue(currentVal, marketData.unit);
                if (currentBandInfo && row.v !== currentVal) {
                    valueDisplay += ` (${ChartUtils.formatValue(row.v, 'index')})`;
                }
                
                html += `
                    <tr>
                        <td>${dateStr}</td>
                        <td class="cell-value">${valueDisplay}</td>
                        <td class="cell-change ${changeClass}">${changeText}</td>
                        <td class="cell-change ${changeClass}">${changePctText}</td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }
        
        // Set range from preset
        function setRangePreset(preset) {
            state.rangePreset = preset;
            
            if (preset === 'MAX') {
                state.startDate = null;
                state.endDate = null;
            } else {
                const days = ChartUtils.RANGE_PRESETS[preset];
                if (days && fullSeries.length > 0) {
                    const end = fullSeries[fullSeries.length - 1].t;
                    const start = new Date(end);
                    start.setDate(start.getDate() - days);
                    state.startDate = start.toISOString().split('T')[0];
                    state.endDate = end.toISOString().split('T')[0];
                }
            }
            
            // Update inputs
            document.getElementById('date-start').value = state.startDate || '';
            document.getElementById('date-end').value = state.endDate || '';
            
            // Update buttons
            document.querySelectorAll('.range-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.range === preset);
            });
            
            updateChart();
        }
        
        // Load market data
        async function loadMarketData() {
            try {
                const response = await fetch('data/latest.json');
                if (!response.ok) throw new Error('Failed to load data');
                
                const data = await response.json();
                marketData = data.markets.find(m => m.name === marketName);
                
                if (!marketData) {
                    document.getElementById('market-name').textContent = 'Market not found';
                    return;
                }
                
                // Update header
                document.getElementById('market-name').textContent = marketData.display_name;
                document.getElementById('market-meta').textContent = `${marketData.category} ‚Ä¢ ${marketData.data_source}`;
                document.getElementById('current-value').textContent = ChartUtils.formatValue(marketData.latest_value, marketData.unit);
                
                const change = marketData.change_absolute;
                const changeClass = change > 0 ? 'positive' : change < 0 ? 'negative' : 'neutral';
                const changeText = change > 0 ? '‚ñ≤ +' : change < 0 ? '‚ñº ' : '‚àí ';
                const changeEl = document.getElementById('current-change');
                changeEl.textContent = changeText + ChartUtils.formatValue(Math.abs(change), marketData.unit) + 
                    ' (' + (marketData.change_percent > 0 ? '+' : '') + marketData.change_percent.toFixed(2) + '%)';
                changeEl.className = `change-display ${changeClass}`;
                
                // Parse full series
                fullSeries = ChartUtils.parseSeries(marketData.history);
                
                // Set initial date inputs
                if (fullSeries.length > 0) {
                    const end = fullSeries[fullSeries.length - 1].t;
                    const start = new Date(end);
                    start.setDate(start.getDate() - 30);
                    document.getElementById('date-end').value = end.toISOString().split('T')[0];
                    document.getElementById('date-start').value = start.toISOString().split('T')[0];
                }
                
                // Render prediction markets
                const pm = predictionMarkets[marketData.name];
                if (pm) {
                    let pmHtml = '';
                    if (pm.kalshi) {
                        pm.kalshi.forEach(m => {
                            pmHtml += `<a href="${m.url}" target="_blank" class="pm-button pm-kalshi">üü¢ ${m.name}</a>`;
                        });
                    }
                    if (pm.polymarket) {
                        pm.polymarket.forEach(m => {
                            pmHtml += `<a href="${m.url}" target="_blank" class="pm-button pm-polymarket">üîµ ${m.name}</a>`;
                        });
                    }
                    document.getElementById('prediction-markets').innerHTML = pmHtml;
                }
                
                // Initial chart
                setRangePreset('30D');
                
            } catch (error) {
                console.error(error);
                document.getElementById('market-name').textContent = 'Error loading data';
            }
        }
        
        // Event listeners
        document.querySelectorAll('[data-tf]').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('[data-tf]').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                state.timeframe = btn.dataset.tf;
                updateChart();
            });
        });
        
        document.querySelectorAll('[data-range]').forEach(btn => {
            btn.addEventListener('click', () => {
                setRangePreset(btn.dataset.range);
            });
        });
        
        document.getElementById('date-start').addEventListener('change', ChartUtils.debounce((e) => {
            state.startDate = e.target.value || null;
            state.rangePreset = null;
            document.querySelectorAll('.range-btn').forEach(b => b.classList.remove('active'));
            updateChart();
        }, 300));
        
        document.getElementById('date-end').addEventListener('change', ChartUtils.debounce((e) => {
            state.endDate = e.target.value || null;
            state.rangePreset = null;
            document.querySelectorAll('.range-btn').forEach(b => b.classList.remove('active'));
            updateChart();
        }, 300));
        
        document.getElementById('normalize-select').addEventListener('change', (e) => {
            state.normalize = e.target.value;
            updateChart();
        });
        
        // Load data
        loadMarketData();
    </script>
</body>
</html>
